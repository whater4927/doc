# 日志规范

{tip:title=注意}
本文采用了Markdown编写，请勿直接在KM上更新该文档！
{tip}

版本:  ${version}

{info:title=说明}
本页面是美云身份云的日志打印规范，描述了研发日常开发过程中日志打印的标准和要求，是研发人员必读的内容
{info}

{toc}



## 总体原则

1. 日志并不是越多越好，有助于使用者分析问题，解决的问题的日志打印才是有价值的，不得胡乱打印日志。

2. 日志打印控制精简，不得长篇大论，最好控制在20-50个words。

3. 日志打印采用中文，考虑到目前的人员英语水平，打印日志采用中文打印，目前此部分的操作可以考虑新加的，修改的部分采用中文，不调整改变的部分，采用英文

4. 日志打印采用SLF4J+LOG4J2的日志框架

5. 考虑日志对性能的影响:日志的频繁打印会对模块的性能产生极大的影响。当日志产生的速度大于日志文件写磁盘的速度，会导致日志内容积压在内存中，导致内存泄漏。

6. 不打印重复的日志，避免重复打印日志，浪费磁盘空间，务必在log4j2.xml中设置 additivity = false

7. 不打无用的、无意义、不完全的日志。打印无意义的日志等于谋杀例如：

   ```java
   if(message instanceof TextMessage){
   	//do sth
   }else{    
   	log.warn("Unknown message type");
   }
   ```

   上面打印的warn信息，看日志根本无法清楚识别消息类型是什么，上述例子只是充当了提示信息，对解决问题毫无帮助。
   *正确的打印内容应该是：* 消息类型；消息ID；上下文信息；出问题的原因等

   ```java
   log.info("call service start...");
   ...
   log.info("call service end...");
   ...
   log.info("service called failed...");
   
   ```

   当我们看到这样的日志的时候，没有包含任何有意义的信息。调用开始，使用者想知道谁调用的，入参是啥；调用结束，使用者想知道调用结果，出参是啥，调用成功还是失败；同样，用户签约失败，想使用者知道的是哪个用户失败，为什么失败；显然都没展示，所以这样的日志是没有任何意义的。

8. 不得吃掉异常，异常要么throw出去，要么使用日志打印出来，建议打印方式如下：

   ```java
   try{
       ...
   } catch(Exception e) {
       LOG.error("process business error {}, {}", e.getMessage(), e);
   }
   ```

   注意：要么Throw出来，要么日志打印，不得同时使用两种方式。

9. 不得使用System.out，e.printStackTrace来打印日志。

10. 不打印混淆信息的日志：所打印出来的日志都应该是清楚准确的表达，当你不能确定具体原因的时候，不能在日志中只是展示一种可能的情况，这样会影响对问题的判断，这样的日志千万不能打。

   ```java
   Connection connection = ConnectionFactory.getConnection();
   if (connection == null) {
       log.warn("System initialized unsuccessfully"); 
   } 
   ```

   这里明显是连接无法连接了，应该打印连接异常，且要输出连接的具体参数。

   ```java
   Connection connection = ConnectionFactory.getConnection();
   if (connection == null) {
       log.warn("connection to database [{}] failed.", CONNECTION_INFO); 
   } 
   ```

11. 不得在循环里面打印日志，但是建议对循环处理的数据量进行汇总后打印输出。

   ```java
   for(String user: users){
       doSomething();
       LOG.debug("create user {}", user);//错误的示范
   }
   LOG.info("process {} users for some bussiness", users.size());
   ```

11. 谨慎地选择记录日志的级别，生产不得使用debug日志，日志级别的定义，请参看日志级别章节。

12. 打印日志不得引入新的异常，特别是空指针异常，不为了打印日志，还做为空检查。

    ```java
    LOG.debug("Processing request with id: {}", request.getId());
    //request对象如果是null，那么就会出现NPE。
    ```

13. 日志打印的时候，假如需要处理列表、数组类的数据，最好是只输出对象的大小，或者某些关键字段，不得打印集合对象，这回造成极大的资源开销。

14. 使用参数化信息的方式:不要进行字符串拼接,那样会产生很多String对象，占用空间，影响性能

    ```java
    LOG.debug("Processing trade with id: " + id + " symbol: " + symbol);
    //错误的示例
    ```

    正确的方式是使用占位符级别

    ```java
    LOG.debug("Processing trade with id: {} symbol: {}", idm, symbol);
    //正确的示例
    ```

15. 使用[]进行参数变量隔离， 需要输出参数的时候，使用[]隔离。

    ```java
    public void createUser(String userid, User user){
        create();
        LOG.debug("create user [{}] finished.", userid);
    }
    ```
    
16. 不常用的ELSE一定要打印日志，比如90%都是走IF流程，这的ELSE中一定要打印日志。

17. SWITCH开关的DEFAULT一定要打印日志，正常执行都是选择了特定的CASE，一旦进入默认的需要打印日志。

18. 对外API接口需要打印入参，和返回的数据信息，且在INFO日志级别输出

## 日志级别

### ERROR

定义：该级别的错误需要马上被处理，当ERROR错误发生时，已经影响了用户的正常访问，是需要马上得到管理员介入并处理的。常见的ERROR异常有：空指针异常，数据库不可用，关键路径的用例无法继续执行等。

影响到程序正常运行、当前请求正常运行的异常情况:

1. 打开配置文件失败
2. 所有第三方对接的异常(包括第三方返回错误码)
3. 所有影响功能使用的异常，包括:SQLException和除了业务异常之外的所有异常(RuntimeException和Exception)
4. 数据库不可用
5. Redis不可用

###　WARN

对于WARN级别的日志，虽然不需要管理员马上处理，但是也需要引起重视。WARN日志有两种级别：一个是解决方案存在明显的问题(例如Try Catch语句中由于不确定会出现什么异常，而用Exception统一捕获抛出的问题)，另一个是潜在的问题和建议(例如系统性能可能会伴随着时间的迁移逐渐不能满足服务需要)。应用程序可以容忍这些信息，不过它们应该被及时地检查及修复。某些用户危险的操作，例如一直采用错误密码尝试登录管理员账号的行为，也可以提升到WARN日志级别记录。

1. 有容错机制的时候出现的错误情况
2. 找不到配置文件，但是系统能自动创建配置文件

即将接近临界值的时候，例如：

1. 缓存池占用达到警告线



### INFO

主要用于记录系统运行状态、用户的操作行为等信息。该日志级别，常用于反馈系统当前状态给最终用户。

系统运行信息

1. Service方法中对于系统/业务状态的变更
2. 核心流程/逻辑中主要分支执行
3. 定时任务的开始执行和执行完成

外部接口部分

1. 客户端请求参数(REST/WS)调用我方接口/我方调用第三方传入的参数和第三方返回的数据
2. 调用第三方时的调用参数和调用结果

### DEBUG

该级别日志的主要作用是对系统每一步的运行状态进行精确的记录。通过该种日志，可以查看某一个操作每一步的执行过程，可以准确定位是何种操作，何种参数，何种顺序导致了某种错误的发生。可以保证在不重现错误的情况下，也可以通过DEBUG级别的日志记录对问题进行诊断。一般来说，在生产环境中，不会输出该级别的日志。

- debug就是给产品分析人员看的，不建议项目开启。
- 业务需要打印出参入参，出参入参用切面打印，采用注解实现，用于开发人员调试。



### TRACE

特别详细的系统运行完成信息，业务代码中，不要使用.(除非有特殊用意，否则请使用DEBUG级别替代)



## 日志打印

###　打印内容

对于重要的核心的模块日志打印需要清晰清楚，日志打印需要建立如下的规范化要求：

1. 定义错误代码，定义简短的错误原因，定义详细的错误原因，其中错误代码和简短错误原因需要输出到日志。详细的错误原因需要呈现到文档

2. 打印日志必须要打印出必要的参数信息，配置信息，不能只打印一句话

3. 日志打印采用如下规范格式

   ```java
   LOG.info("short descrption, PARAMS: [{}], ERRCODE: {}, ERRMSG: {}, POSSIBLE REASON:{}", params, code, msg, reason)
   ```

   其中原因采用简短的描述，不得写过长的描述

### 打印时机

1. 重要的业务，比如同步核心区域需要重点打印流程走向
2. 发现异常，需要打印输出日志，确保日志得以输出
3. 可能出现问题的地方，需要打印输出日志
4. IF的不常用ELSE，SWITCH的DEFAULT中需要输入日志
5. 调用第三方的组件的时候的开始和结束需要打印日志
